@page "/leitorQrCode"

@using BlazorBarcodeScanner.ZXing.JS
@using System.Text.Json;
@using GuieMe.Domain.Interfaces;
@using GuieMe.Views.Components

@inject IObjetivoService ObjetivoService;

<div class="header">
    <div class="rz-p-xl-12 rz-text-align-end rz-mb-2 rz-mr-2">
        <AppMenu_component></AppMenu_component>
    </div>
    @if(erro)
    {
        <RadzenStack Gap="0" class="rz-py-4 rz-px-6">
            <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Filled"
                         AllowClose="true" Title="Erro">
                @mensagemErro
            </RadzenAlert>
        </RadzenStack>
    }
    @if (sucesso)
    {
        <RadzenStack Gap="0" class="rz-py-4 rz-px-6">
            <RadzenAlert AlertStyle="AlertStyle.Success" Variant="Variant.Filled"
                         AllowClose="true" Title="Local lido com sucesso">
                Nome: @localLido.Nome
            </RadzenAlert>
        </RadzenStack>
    }
    <BarcodeReader Title="Leitor QrCode"
        StartCameraAutomatically="true"
        ShowStart="false"
        ShowReset="false"
        ShowResult="true"
        ShowToggleTorch="false"
        ShowVideoDeviceList="false"
        VideoWidth="300"
        VideoHeight="200"
        OnBarcodeReceived="LocalReceivedBarcodeText" />
</div>

@code {
    private string LocalBarcodeText;
    private LocalQrCode localLido;
    private bool erro = false;
    private bool sucesso = false;
    private string mensagemErro = "Ocorreu um erro no aplicativo";

    private void LocalReceivedBarcodeText(BarcodeReceivedEventArgs args)
    {
        try
        {
            this.LocalBarcodeText = args.BarcodeText;

            if (this.LocalBarcodeText.Contains("Id") && this.LocalBarcodeText.Contains("Local"))
            {
                this.erro = false;
                this.localLido = JsonSerializer.Deserialize<LocalQrCode>(this.LocalBarcodeText);
                ObjetivoService.ConcluirObjetivo(this.localLido.Id);
                this.sucesso = true;
            }
            else
            {
                this.sucesso = false;
                this.mensagemErro = "Qr code invalido! não segue os padrões do aplicativo.";
                this.erro = true;
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            this.sucesso = false;
            this.mensagemErro = "Erro na leitura do Qr Code.";
            this.erro = true;
        }
    }
}
